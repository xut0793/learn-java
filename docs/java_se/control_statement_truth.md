# 流程控制的真相

> 以上内容摘自 《Java 编程的逻辑》 ch 1.4.2

## 顺序执行

程序最终编译成机器码，都是一条条的指令，CPU 有一个指令指示器，指向下一条要执行的指令，CPU 根据指示器的指示加载指令并且执行。

这些指令大部分都是具体的操作和运算，在执行完一个操作后，指令指示器会自动指向紧挨着的下一条指令。这就是程序语句顺序执行的原理。

## 跳转指令

但是有一些特殊的指令，称为跳转指令，这些指令会修改指令指示器的值，让 CPU 跳到一个指定的地方执行。这样的跳转有两种：

- 一种是条件跳转；
- 另一种是无条件跳转。

条件跳转检查某个条件，满足则进行跳转，不满足则继续执行下一条指令。
无条件跳转则是直接进行跳转，不检查任何条件。

```java:line-numbers
int a = 10;
if (a % 2 == 0) {
    System.out.println("a 是偶数");
}
// 其它代码
```

上述代码转换到指令，大概的流程是这样的：

```:line-numbers
int a = 10;
条件跳转：如果 a % 2 == 0，跳转到第4行
无条件跳转：跳转到第7行
{
  System.out.println("a 是偶数");
}
// 其它代码
```

第 3 行的无条件跳转指令，没有它不行吗？不行，没有这条指令，cpu 会顺序执行接下来的指令，导致不管什么条件，括号中的代码都会执行。

## 真相

`if`、`if-else`、`if-else if-else`、`?` 三元运算符、`while`、`do-while`、`break`、`continue`，这些语句都会转换为条件跳转和无条件跳转。

区别在于，在 `if` 等条件语句中，跳转只会往后面跳，而 `for` 等循环语句中会往前面跳。`break/continue` 语句也都会转换为跳转指令，具体就不赘述了。

比较特殊的是 switch 语句。switch 的转换和具体系统实现有关。如果分支比较少，可能会转换为跳转指令。如果分支比较多，使用条件跳转会进行很多次的比较运算，效率比较低，可能会使用一种更为高效的方式，叫跳转表。

## switch 语句的跳转表

**跳转表是一个映射表**，存储了可能的值以及要跳转到的地址，直接根据值查找地址，效率很高。

switch 表达式的值类型最终会被转换为 int 类型：

- byte/short/int 本来就是整数
- char 本质上也是整数（2.4 节介绍）​
- 枚举类型也有对应的整数（5.4 节介绍）
- String 是通过 hashCode 方法（7.2 节介绍）转换为整数的，但不同 String 的 hashCode 可能相同，跳转后会再次根据 String 的内容进行比较判断。

> 为什么 long / float / double 不能用于 switch 语句？跳转表值的存储空间一般为 32 位，容纳不下 long。

case 子句的值在程序编写时不要求是排序的，但是编译器会自动排序。

- 对于有序的整数序列，可以使用高效的二分查找。
- 如果值是连续的，则会进一步进行特殊优化为一个数组，连找都不用找了，值就是数组的下标索引，直接根据值就可以找到跳转的地址。
- 即使值不是连续的，但数字比较密集，差的不多，编译器也可能会优化为一个数组型的跳转表，没有的值指向 default 分支。

所以 switch 语句会比 if 语句更高效。
